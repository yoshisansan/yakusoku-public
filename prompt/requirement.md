# 要件定義書: Notionタスク LINE通知システム

## 1. システム概要
Notionのタスク管理データベースを参照し、「締切日」と任意の「リスケ日」プロパティから算出した**通知対象日**について、(1) 通知対象日の当日（= 今日）および (2) 通知対象日の3日前にあたる日に、該当タスクを抽出してLINE Messaging APIを使用してユーザーにプッシュ通知を行うシステム。
参照記事の実装をベースとするが、インフラとして**GitHub Actions**のCron機能を利用し、サーバーレスかつ無料で定期実行を実現する。

**参照記事(Vercelを使用しているため注意)**: [Notion APIを使って締切日が「今日」のタスクをLINE通知してみた](https://gyas.co.jp/knowledge_blog/notion-api-line-notify/)

## 2. 目的
- 日々のタスク締切日をLINEで受け取ることで、タスクの失念を防止する。
- Notionを開かずに当日のタスクを把握できるようにする。

## 3. 機能要件

### 3.1. タスク取得機能
- **Notion API**を使用し、指定されたデータベースからタスクを取得する。
- **使用するプロパティ**:
  - プロパティ「締切日」（Date型）: 元の締切日。
  - プロパティ「リスケ日」（Date型・任意）: 締切日を守れない場合にユーザーが手動で設定する新しい日付。
- **抽出条件**:
  - 各タスクについて「通知対象日」を次のルールで決定する。
    - 「リスケ日」が存在し、かつ「リスケ日」 > 「締切日」の場合 → 通知対象日 = リスケ日。
    - 上記以外 → 通知対象日 = 締切日。
  - 通知対象日が実行日（今日）と一致するタスク、または実行日から見て3日後が通知対象日となるタスク（= 通知対象日の3日前にあたる日）を取得する。
- **取得項目**:
  - タスク名（Titleプロパティ）
  - （拡張性考慮: 必要であればURLやステータスも取得可能）

### 3.2. LINE通知機能
- **LINE Messaging API**を使用し、特定ユーザー（自分）へプッシュ通知を行う。
- **通知メッセージ形式**:
  - ヘッダー: 「本日および3日後が締切（またはリスケ日）のタスクは以下です。」
  - ボディ: 取得したタスクのリスト（箇条書き）。
- **通知条件**:
  - 対象タスクが1件以上ある場合のみ通知する。
  - タスクの完了/未完了ステータスに関わらず、「締切日」が今日のタスクはすべて通知対象とする。

### 3.3. 定期実行機能
- **GitHub Actions**を使用する。
- **実行スケジュール**:
  - 毎日 19:00 (JST) に実行。
  - Cron設定値: `0 10 * * *` (UTC) ※JSTはUTC+9時間
  - 手動実行（workflow_dispatch）も可能にする。

## 4. 技術スタック
- **ランタイム**: Node.js (v20系)
- **言語**: TypeScript
- **ライブラリ**:
  - `date-fns`: 日付操作・フォーマット
  - `dotenv`: 環境変数管理（ローカル開発用）
  - `node-fetch` または `axios`: HTTPリクエスト
  - （任意）`@notionhq/client`: Notion公式SDK（型安全性のため推奨）
- **インフラ**: GitHub Actions (Ubuntu latest)

## 5. データフロー
1. GitHub Actionsがスケジュール（毎日19:00 JST）に基づきワークフローを起動。
2. 環境変数をセットアップし、TypeScriptスクリプトを実行。
3. Notion APIへクエリを送信し、「締切日」と「リスケ日」に基づいて、本日が通知対象日の当日または3日前にあたるタスクを検索。
4. 検索結果を整形し、通知用メッセージを作成。
5. タスクが存在する場合、LINE Messaging APIへメッセージ送信リクエストを実行。
6. LINEアプリに通知が届く。

## 6. 環境変数 / Secrets
以下の情報を `.env` (ローカル) および GitHub Actions Secrets (本番) に設定する。

| 変数名 | 説明 |
| --- | --- |
| `NOTION_API_KEY` | Notion IntegrationのSecret Key |
| `NOTION_DATABASE_ID` | タスク管理データベースのID |
| `LINE_CHANNEL_ACCESS_TOKEN` | LINE Messaging APIのチャネルアクセストークン |
| `LINE_USER_ID` | 通知送付先のLINEユーザーID |

## 7. ディレクトリ構成案
```
.
├── .github/
│   └── workflows/
│       └── notify-tasks.yml  # 定期実行用定義
├── src/
│   ├── index.ts              # エントリーポイント
│   ├── notion.ts             # Notion APIロジック
│   └── line.ts               # LINE APIロジック
├── package.json
├── tsconfig.json
└── .env.example
```

## 8. 確認・検討事項
開発を開始する前に以下の点を確認してください。

1.  **Notionデータベースのプロパティ名**:
    - 記事では「期限」「タスク名」となっていますが、あなたのデータベースに「締切日」（Date型）と「リスケ日」（Date型・任意）のプロパティが正しく定義されていますか？（例: 英語で `Due`, `Rescheduled` になっているなど）
2.  **仕様として確定している点（参考）**:
    - 各タスクは「締切日」と任意の「リスケ日」を持ち、「リスケ日」が「締切日」より新しい場合は通知対象日として「リスケ日」を利用する。
    - 通知は、各タスクの通知対象日の当日とその3日前に行う。
    - タスクは完了済みも含めてすべて通知対象とする。
    - 通知タイミングは毎日 19:00 JST とする（GitHub Actions Cron: `0 10 * * *`）。
